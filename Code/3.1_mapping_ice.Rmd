---
title: "Step 3.1: Mapping Neighborhood Characteristics of Cohort"
author: "Mia Charifson"
date: "2023-10-29"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning=FALSE, message=FALSE, fig.width=6, fig.height = 4)
knitr::opts_knit$set(root.dir = '/Users/miacharifson/Library/CloudStorage/OneDrive-NYULangoneHealth/Charifson Dissertation/')
```

## Introduction

This document presents various figures and maps related to the neighborhood characteristics used in chapter one of my dissertation. The two neighborhood characteristics of interest are:

(1) Index of concentration of the extremes, race & income (ICE-RI)
(2) Gentrification index

```{r lib}
library(tidyverse)
library(ggplot2)
library(ggpubr)
library(sf)
library(tidycensus)
library(readxl)
```

```{r load}
pat_cohort <- read.csv('Data/Derived/pat_cohort_w_censoring.csv') %>% select(-X)
res_his <- read.csv('Data/Derived/baseline_cohort_addresses.csv') %>% select(-X)
gent_index <- read_excel('Data/External/gentrification_index/NYC_Gentrification_2000_16.xlsx', 1)
load("Data/External/ACS_ICE_RI_2016_2022_w_geography.RData")
```

```{r cleans}
# subset the gentrification index file
gent_index_sub <- gent_index %>% select(tractid, nta_name, scores_raw)

# reformat the nyc geo file to only 2017
nyc_geo2017 <- nyc_all_geo %>% 
  filter(year==2017 & 
           grepl('Bronx County|Kings County|New York County|Queens County|Richmond County', NAME)) %>%
  select(-moe, -year) %>% 
  spread(variable, estimate, sep = NULL) %>% 
  mutate(
    A = white100_125+white125_150+white150_200+white_above200,
    P = black_less10+black10_15+black15_20+black20_25,
    T = total_white_hh + total_black_hh,
    ICE_RI = (A-P)/T
  )

# remove non-NYC patients from the cohort
res_his_nyc <- res_his %>%
  filter(baseline_addr) %>%
  filter(substr(full_fips_tract_final, 1, 5) %in% c(36005, 36047, 36061, 36081, 36085))
  

# join all together
df <- nyc_geo_2017 %>%
```

## New York City Census Tract Geography

There are `r length(unique(nyc_geo2017$NAME))` census tracts in NYC in 2017. Of those census tracts, our cohort population has patients from `r length(unique(res_his$census_tract_final))` census tracts. 

The map below shows the relative count of patients per census tract. 

```{r cohort_weights}
```

## Mapping ICE-RI and Gentrification

### Entire NYC

```{r nyc_ice}
# make that map for the 2017 data
nyc_geo2017 %>%
  separate(NAME, into = c(NA, "name"), sep = ", ") %>%  # remove
  ggplot() +
  geom_sf(aes(fill = ICE_RI)) +
  coord_sf(crs = st_crs(nyc_geo2017), datum = NA) + 
  #geom_sf_label(aes(label = name), fill = "gray95", size = 2.5, alpha = 0.9) +
  scale_fill_viridis_c() +
  labs(
    title = "Index of concentration at the extremes, race & income",
    subtitle = "New York City, 5-year 2017 ACS data"
  ) +
  theme_void()
```

```{r nyc_gentrification}
```

### In Our Cohort

```{r cohort_ice}
```

```{r cohort_gentrification}
```

## Relocation leading to changes in ICE throughout follow-up

The below maps show how the distribution of ICE-RI changes in out cohort over time.

```{r ice_boxplot_over_FU}

```

X patients relocate during follow-up. 

Of these patients, X relocate to a new census tract at least once during follow-up. 

Of the X that change census tracts, X relocations result in the change in ICE-RI exposure. 

The distribution of these changes are visualized below. 

```{r ice_relocation_fig}

```
