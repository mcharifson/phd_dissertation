---
title: "Validation Analysis"
author: "Mia Charifson"
date: "2024-06-03"
output: 
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE, message=FALSE)
knitr::opts_knit$set(root.dir = '/Users/miacharifson/Library/CloudStorage/OneDrive-NYULangoneHealth/Charifson Dissertation/')

library(tidyverse)
library(ggplot2)
library(dplyr)
library(lubridate)
library(arsenal)
library(yardstick)
library(kableExtra)
```

Last updated on: `r today()`.

```{r load}
redcap_df <- read.csv('Data/Derived/Chart Review/training_v1_export.csv')
uf_cohort <- read.csv('Data/Derived/uf_all_hints.csv')
endo_cohort <- read.csv('Data/Derived/endo_all_hints.csv')
false_negatives <- read.csv('Data/Derived/putative_false_negatives.csv')
pat_cohort <- read.csv('Data/Derived/pat_cohort_w_censoring.csv')


# for training data just use my review
true_df <- redcap_df %>% filter(redcap_event_name == 'mia_arm_1')
```

```{r mk_pred_df}
pred_df <- pat_cohort %>% filter(pat_mrn_id %in% true_df$mrn) %>%
  select(pat_mrn_id, pat_id, index_enc_date) %>% rename(mrn=pat_mrn_id) %>%
  left_join(uf_cohort %>% 
              select(pat_id, confident_incident, confident_prevalent, first_dx_date, 
                     first_confirm_date, first_confirm_type, first_location_date) %>%
              rename_all(~paste0("uf_", .)),
            by=c('pat_id' = 'uf_pat_id')) %>%
  left_join(endo_cohort %>%
              select(pat_id, confident_incident, confident_prevalent, first_dx_date, 
                     first_confirm_date, first_confirm_type, first_location_date) %>%
              rename_all(~paste0("endo_", .)),
            by=c('pat_id' = 'endo_pat_id')) %>%
  mutate(uf_pred_dx = case_when(uf_confident_incident~'Incident',
                                !uf_confident_incident | uf_confident_prevalent~'Prevalent',
                                TRUE~'No UF'),
         endo_pred_dx = case_when(endo_confident_incident~'Incident',
                                  !endo_confident_incident | endo_confident_prevalent~'Prevalent',
                                TRUE~'No Endo'),
         uf_first_dx_date = as.Date(uf_first_dx_date), 
         endo_first_dx_date = as.Date(endo_first_dx_date), 
         final_outcome_status = case_when(uf_pred_dx=='Incident' & endo_pred_dx=='Incident' ~'Both Incident',
                                          uf_pred_dx=='Incident' & endo_pred_dx!='Incident'~'Incident UF only',
                                          uf_pred_dx!='Incident' & endo_pred_dx=='Incident'~'Incident Endo only',
                                          TRUE~'Neither incident')) 
```

## Clean the data

For each chart reviewed case, extract the following for UF and Endo: 

- Gold standard status: met at least one gold standard for diagnosis (t/f)
- Confirmation types: medical history, problem list, imaging, surgery, notes (t/f)
- Earliest dx date: earliest date of gold standard diagnosis

```{r}
true_df %>%
  # make date columns into dates
  mutate(across(contains('date') & !contains('note') & !contains('patient'), ~as.Date(.))) %>%
  # determine earliest dx date
  mutate(uf_earliest_dx_date = pmin(medical_hx_date_uf, problem_list_date_uf, 
                                imaging_confirmed_date_uf, surgery_confirmed_date_uf, na.rm=TRUE),
         endo_earliest_dx_date = pmin(medical_hx_date_endo, problem_list_date_endo, 
                                     imaging_confirmed_date_endo, surgery_confirmed_date_endo, na.rm=TRUE)) %>%
  select(mrn, uf_earliest_dx_date, medical_hx_uf, problem_list_uf,imaging_confirmed_uf, surgery_confirmed_uf, 
         hx_note_date_uf) %>%
  mutate(sum = medical_hx_uf + problem_list_uf + imaging_confirmed_uf + surgery_confirmed_uf,
         prevalent_dx = uf_earliest_dx_date <= '2016-08-01',
         prevalent_note = as.Date(hx_note_date_uf) <= '2016-08-01')
```


```{r clean_redcap_data}
true_df_clean <- true_df %>%
  # make date columns into dates
  mutate(across(contains('date') & !contains('note_dx') & !contains('patient'), ~as.Date(.))) %>%
  # determine earliest dx date
  mutate(uf_earliest_dx_date = pmin(medical_hx_date_uf, problem_list_date_uf, 
                                imaging_confirmed_date_uf, surgery_confirmed_date_uf, na.rm=TRUE),
         endo_earliest_dx_date = pmin(medical_hx_date_endo, problem_list_date_endo, 
                                     imaging_confirmed_date_endo, surgery_confirmed_date_endo, na.rm=TRUE)) %>%
  # determine gold standard status
  group_by(mrn) %>%
  mutate(uf_gold_dx = case_when(uf_earliest_dx_date <= '2016-08-01' | hx_note_date_uf <= '2016-08-01'~'Prevalent', 
                                sum(medical_hx_uf, problem_list_uf,
                                    imaging_confirmed_uf, surgery_confirmed_uf)>=1~'Incident',
                                TRUE~'No UF'),
         endo_gold_dx = case_when(endo_earliest_dx_date <= '2016-08-01' | hx_note_date_endo <= '2016-08-01'~'Prevalent', 
                                  sum(medical_hx_endo, problem_list_endo,
                                      imaging_confirmed_endo, surgery_confirmed_endo)>=1~'Incident',
                                  TRUE~'No Endo')) %>%
  ungroup() %>%
  select(mrn, uf_gold_dx, uf_earliest_dx_date, endo_gold_dx, endo_earliest_dx_date, contains('note'))

summary(true_df_clean)
```

## Join with outcome via algorithm

Next, compare their chart review abstraction to their algorithm outcome for UF and Endo:

- Algorithm outcome status: UF only, Endo only, Both, Control, Hesitant case, Potential false negative
- Algorithm first dx date: if they are a putative case, what is their earliest dx date
- Status match: Does their algorithm status match their chart review status?
- First dx match: If they are a case for both algorithm and chart review, is their first dx date within 60 days of their first gold standard diagnosis date? CAVEAT: do they have a note of historical dx at or before their first dx date?

```{r}
uf_final <- true_df_clean %>%
  select(mrn, uf_gold_dx, uf_earliest_dx_date) %>%
  left_join(pred_df %>% select(mrn, index_enc_date, uf_pred_dx, uf_first_dx_date) %>%
              rename(uf_pred_dx_date = uf_first_dx_date),
            by='mrn') %>%
  # to handle missing level for now
  add_row(mrn=999, uf_pred_dx = 'Prevalent') %>%
  mutate(true_v_pred_date_gap = as.numeric(uf_earliest_dx_date-uf_pred_dx_date), 
         uf_prevalent_status = case_when(abs(true_v_pred_date_gap)<=60~FALSE,
                                         abs(true_v_pred_date_gap)>60~TRUE,
                                         TRUE~NA),
         uf_gold_dx = as.factor(uf_gold_dx), 
         uf_pred_dx = as.factor(uf_pred_dx)) %>%
  # remove missing patient and fake patient
  filter(!is.na(uf_pred_dx) & mrn != 999)

endo_final <- true_df_clean %>%
  select(mrn, endo_gold_dx, endo_earliest_dx_date) %>%
  left_join(pred_df %>% select(mrn, index_enc_date, endo_pred_dx, endo_first_dx_date) %>%
              rename(endo_pred_dx_date = endo_first_dx_date),
            by='mrn') %>%
  # to handle missing level for now
  #add_row(mrn=999, endo_pred_dx = 'Prevalent') %>%
  mutate(true_v_pred_date_gap = as.numeric(endo_earliest_dx_date-endo_pred_dx_date), 
         endo_prevalent_status = case_when(abs(true_v_pred_date_gap)<=60~FALSE,
                                         abs(true_v_pred_date_gap)>60~TRUE,
                                         TRUE~NA),
         endo_gold_dx = as.factor(endo_gold_dx), endo_pred_dx = as.factor(endo_pred_dx)) %>%
  # remove missing patient
  filter(!is.na(endo_pred_dx) & mrn != 999)
```

## Confusion matrices 

To run the validation statistics, I need to create a 'truth' column from the validation (`validated_status`) and an 'estimated' column from the algorithm (`putative_status`). I will need to do this for several events: 

1. Being an incident UF case
2. Being an incident Endo case
3. Being a disease-free patient during FU (change the `event-level`)
4. Being a prevalent UF case (here we can use either the `macro` method, group by outcome)
5. Being a prevalent Endo case
6. Being a false positive (i.e. we assume false positives are putative cases, what is the PPV)
7. All levels

Using multiclass classification (`macro` method), we can keep the prevalent cases in the data and still calcualte the relative TPR, TNR, PPV and NPV for each class respectively. See more in depth description [here](https://towardsdatascience.com/multi-class-classification-extracting-performance-metrics-from-the-confusion-matrix-b379b427a872).


### Main validation {.tabset}

#### Uterine fibroid cases/controls

```{r}
t <- table(uf_final$uf_gold_dx, uf_final$uf_pred_dx)
kable(addmargins(t), col.names = c('Incident (pred)', 'No UF (pred)', 'Prevalent (pred)', 'Sum')) %>% kable_styling()
```


```{r}
ppv(uf_final, uf_gold_dx, uf_pred_dx, na_rm=TRUE) # doesn't render bc of empty cell?
```


```{r uf_cases}
# make table
uf_metrics <- tibble(ppv = numeric(), sens = numeric(), spec = numeric())
# get metrics
uf_metrics[1, 1] <- ppv(uf_final, uf_gold_dx, uf_pred_dx)$.estimate
# use binary here --> can also use macro for incident case, prevalent case, control
# event_level specifies which level of the truth is the event (in our case, having the condition)
uf_metrics[1, 2] <- sens(uf_final, uf_gold_dx, uf_pred_dx)$.estimate
uf_metrics[1, 3] <- spec(uf_final, uf_gold_dx, uf_pred_dx)$.estimate
# print table
uf_metrics
```

```{r uf_dx_date_accuracy}
ggplot(aes(x=true_v_pred_date_gap), data=uf_final) +
  geom_histogram(bins = 20, color='white') +
  geom_vline(xintercept = 60, color='red') +
  geom_vline(xintercept = -60, color='red') +
  xlab('Earlier true date <-- Same date --> Later true date') +
  theme_bw()
```

#### Endo cases/controls

```{r}
t <- table(endo_final$endo_gold_dx, endo_final$endo_pred_dx)
kable(addmargins(t), col.names = c('Incident (pred)', 'No Endo (pred)', 'Sum')) %>% kable_styling()
```

```{r endo_cases}
# make table
endo_metrics <- tibble(ppv = numeric(), sens = numeric(), spec = numeric())
# get metrics
endo_metrics[1, 1] <- ppv(endo_final, endo_gold_dx, endo_pred_dx)$.estimate
# use binary here --> can also use macro for incident case, prevalent case, control
# event_level specifies which level of the truth is the event (in our case, having the condition)
endo_metrics[1, 2] <- sens(endo_final, endo_gold_dx, endo_pred_dx)$.estimate
endo_metrics[1, 3] <- spec(endo_final, endo_gold_dx, endo_pred_dx)$.estimate
# print table
endo_metrics
```
```{r endo_dx_date_accuracy}
ggplot(aes(x=true_v_pred_date_gap), data=endo_final) +
  geom_histogram(bins = 20, color='white') +
  geom_vline(xintercept = 60, color='red') +
  geom_vline(xintercept = -60, color='red') +
  xlab('Earlier true date <-- Same date --> Later true date') +
  theme_bw()
```

#### {.unnumbered}

### Sensitivity validations {.tabset}

#### Both cases

What percent are truly both? What percent are one but not the other? What percent are neither?

#### Hesitant cases

What percent are controls? What percent are prevalent cases? What percent are true cases?

#### False negatives

What percent are controls? What percent are prevalent cases? What percent are true cases?

#### {.unnumbered}